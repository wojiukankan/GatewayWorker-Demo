<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
</head>
<body>
<div id="content">

</div>
<input type="text" id="text">
<input type="button" id="btn" value="发送">
</body>
<script src="__STATIC__/js/jquery-3.3.1.min.js"></script>
<script src="__STATIC__/js/jquery.cookie.js"></script>
<script>
    /**
     * 与GatewayWorker建立websocket连接，域名和端口改为你实际的域名端口，
     * 其中端口为Gateway端口，即start_gateway.php指定的端口。
     * start_gateway.php 中需要指定websocket协议，像这样
     * $gateway = new Gateway(websocket://0.0.0.0:7272);
     */
    ws = new WebSocket("ws://tp.testtp.top:8282");
    // 服务端主动推送消息时会触发这里的onmessage
    ws.onmessage = function(e){
        console.log(e);
        // json数据转换成js对象
        var data = JSON.parse(e.data);
        var type = data.type || '';
        switch(type){
            // Events.php中返回的init类型的消息，将client_id发给后台进行uid绑定
            case 'init':
                // 利用jquery发起ajax请求，将client_id发给后端进行uid绑定
                getName();
                break;
            case 'ping':
                // 利用jquery发起ajax请求，将client_id发给后端进行uid绑定
                break;
            // 当mvc框架调用GatewayClient发消息时直接alert出来
            default :
                var html = '<p>' + data.data + '</p>';
                $("#content").append(html);
            // alert(e.data);
        }
    };
    $("#btn").on('click', function () {
        var value = $("#text").val();
        ws.send(value);
    })
    function getName() {
        if(!$.cookie('name')){
            var name = prompt('请输入昵称');
            if(name){
                $.post("{:url('index')}", {client_id: data.client_id,name:name}, function(data){}, 'json');
            }else{
                return false;
            }
        }
    }
</script>
</html>